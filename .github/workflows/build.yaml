name: Build oJob.io

on:
  #push:
  #  branches: [ master ]
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest
    #permissions:
    #  contents: write
    #  pull-requests: write
      
    steps  :
    # --------------------------
    - name: Cache OpenAF runtime
      uses: actions/cache@v3
      with:
        key : oaf-nightly
        path: /tmp/oaf
        
    # -------------------------
    - uses: actions/checkout@v2

    # --------------------------
    - name: Install oJobIO opack
      uses: openaf/ojob-action@v4
      with:
        dist: nightly
        def : |
          todo:
          - Install aux packs
          - Copy files
          - Run Setup oJobIO
          - Run Rebuild

          jobs:
          - name: Install aux packs
            lang: shell
            exec: |
              /tmp/oaf/opack install ojobio
              /tmp/oaf/opack install ojob-common

          - name: Copy files
            lang: shell
            exec: |
              mkdir .dist
              cp -R /tmp/oaf/oJobIO/* .dist
              cd .dist
              ls -lad *
              find imgs | wc
              find ojobs | wc
              echo "__threadPoolFactor=4;" > ~/.openaf_profile

          - name: Run Setup oJobIO
            lang: shell
            typeArgs:
              shellPrefix: setupOJobIO
            exec: |
              /tmp/oaf/ojob setupOJobIO.yaml
              find ojobs | wc

          - name: Run Rebuild
            lang: shell
            typeArgs:
              shellPrefix: rebuild
            exec: |
              /tmp/oaf/ojob rebuild.yaml NAME=ojob.io URL=ojob.io PROTO=https

    # -----------------------
    - name: Copy build result
      run : |
        find .dist